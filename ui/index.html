<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê GitHub Security Scraper - Live Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .severity-critical { @apply bg-red-100 text-red-800 border-red-300; }
        .severity-high { @apply bg-orange-100 text-orange-800 border-orange-300; }
        .severity-medium { @apply bg-yellow-100 text-yellow-800 border-yellow-300; }
        .severity-low { @apply bg-blue-100 text-blue-800 border-blue-300; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-shield-alt text-3xl text-blue-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">GitHub Security Scraper</h1>
                        <p class="text-sm text-gray-500">Live monitoring - 95 patterns active</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="liveStatus" class="flex items-center space-x-2">
                        <span class="pulse h-3 w-3 bg-green-500 rounded-full"></span>
                        <span class="text-sm text-green-600 font-medium">LIVE</span>
                    </span>
                    <span id="lastUpdate" class="text-sm text-gray-500"></span>
                    <button onclick="refreshData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Findings</p>
                        <p id="totalFindings" class="text-3xl font-bold text-gray-900 mt-2">-</p>
                    </div>
                    <div class="bg-blue-100 rounded-full p-4">
                        <i class="fas fa-database text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Critical</p>
                        <p id="criticalFindings" class="text-3xl font-bold text-red-600 mt-2">-</p>
                    </div>
                    <div class="bg-red-100 rounded-full p-4">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">With Balance</p>
                        <p id="fundedFindings" class="text-3xl font-bold text-green-600 mt-2">-</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-4">
                        <i class="fas fa-wallet text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Scans</p>
                        <p id="totalScans" class="text-3xl font-bold text-purple-600 mt-2">-</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-4">
                        <i class="fas fa-search text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-8">
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="Search repositories..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                </div>
                <select id="severityFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Severities</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">All Status</option>
                    <option value="new">New</option>
                    <option value="investigating">Investigating</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="resolved">Resolved</option>
                    <option value="ignored">Ignored</option>
                </select>
            </div>
        </div>

        <!-- Findings Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-900">Recent Findings</h2>
                <span class="text-sm text-gray-500">Auto-refresh: 30s</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Repository</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pattern Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Discovered</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="findingsTable" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                                <p>Loading findings...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://nykctocknzbstdqnfkun.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im55a2N0b2Nrbnpic3RkcW5ma3VuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzMwMDYsImV4cCI6MjA3MzgwOTAwNn0.ZRI5O5sqDVUJu431RyrOsZ5qeIDdSn7U5FBNBooURuQ';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let allFindings = [];

        async function loadStatistics() {
            const { data: findings } = await supabase.from('github_security_findings').select('*');
            const { data: scans } = await supabase.from('github_scan_history').select('*');

            document.getElementById('totalFindings').textContent = findings?.length || 0;
            document.getElementById('criticalFindings').textContent = findings?.filter(f => f.severity === 'critical').length || 0;
            document.getElementById('fundedFindings').textContent = findings?.filter(f => f.metadata?.has_balance).length || 0;
            document.getElementById('totalScans').textContent = scans?.length || 0;
        }

        async function loadFindings() {
            const { data, error } = await supabase
                .from('github_security_findings')
                .select('*')
                .order('discovered_at', { ascending: false })
                .limit(100);

            if (error) {
                console.error('Error loading findings:', error);
                return;
            }

            allFindings = data || [];
            renderFindings(allFindings);
        }

        function renderFindings(findings) {
            const tbody = document.getElementById('findingsTable');

            if (findings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                            <p>No findings yet. System is secure! üéâ</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = findings.map(finding => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <a href="${finding.repository_url}" target="_blank" class="text-blue-600 hover:underline font-medium">
                            ${finding.repository_name}
                        </a>
                        ${finding.metadata?.has_balance ? '<span class="ml-2 text-xs bg-green-100 text-green-800 px-2 py-1 rounded">üí∞ Funded</span>' : ''}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        ${finding.file_path || 'N/A'}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800">
                            ${finding.pattern_type}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 text-xs font-semibold rounded-full severity-${finding.severity}">
                            ${finding.severity.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusClass(finding.status)}">
                            ${finding.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">
                        ${new Date(finding.discovered_at).toLocaleString()}
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="viewDetails('${finding.id}')" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            const classes = {
                'new': 'bg-orange-100 text-orange-800',
                'investigating': 'bg-yellow-100 text-yellow-800',
                'confirmed': 'bg-red-100 text-red-800',
                'resolved': 'bg-green-100 text-green-800',
                'ignored': 'bg-gray-100 text-gray-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function viewDetails(id) {
            const finding = allFindings.find(f => f.id === id);
            alert(`Finding Details:\n\n${JSON.stringify(finding, null, 2)}`);
        }

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('severityFilter').addEventListener('change', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const severity = document.getElementById('severityFilter').value;
            const status = document.getElementById('statusFilter').value;

            const filtered = allFindings.filter(finding => {
                const matchesSearch = finding.repository_name.toLowerCase().includes(search);
                const matchesSeverity = !severity || finding.severity === severity;
                const matchesStatus = !status || finding.status === status;
                return matchesSearch && matchesSeverity && matchesStatus;
            });

            renderFindings(filtered);
        }

        async function refreshData() {
            document.getElementById('lastUpdate').textContent = 'Refreshing...';
            await loadStatistics();
            await loadFindings();
            document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        // Initialize
        refreshData();
        setInterval(refreshData, 30000); // Auto-refresh every 30s
    </script>
</body>
</html>